<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Laboratory 4 - Music Library</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

    <style>
        .album-img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }

        .card.h-100 {
            display: flex;
            flex-direction: column;
        }

        .card .card-body {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .card-footer {
            background: transparent;
            border-top: 0;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <header class="mb-4">
            <h1 class="h3">Music Library</h1>
            <p class="text-muted mb-0">Albums loaded dynamically from <code>library.json</code></p>
        </header>
        <div id="albumsRow" class="row"></div>
    </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <script>
        const FALLBACK_LIBRARY = [
            {
                "id": "1", "artist": "Iron Maiden", "title": "Brave New World", "thumbnail": "1.jpg",
                "tracks": [{ "number": 1, "title": "The Wicker Man", "length": "4:35", "url": "https://open.spotify.com/" }]
            },
            {
                "id": "2", "artist": "Killswitch Engage", "title": "As Daylight Dies", "thumbnail": "2.jpg",
                "tracks": [{ "number": 1, "title": "This Fire Burns", "length": "3:21", "url": "https://open.spotify.com/" }]
            }
        ];

        function el(tag, opts = {}) {
            const e = document.createElement(tag);
            if (opts.class) e.className = opts.class;
            if (opts.text) e.textContent = opts.text;
            if (opts.html) e.innerHTML = opts.html;
            if (opts.attrs) Object.entries(opts.attrs || {}).forEach(([k, v]) => e.setAttribute(k, v));
            return e;
        }

        async function loadAlbums() {
            const row = document.getElementById('albumsRow');
            const jsonUrl = 'data/library.json'; 
            console.log('[DEBUG] Fetching library.json from:', jsonUrl);

            try {
                const res = await fetch(jsonUrl, { cache: 'no-store' });
                console.log(`[DEBUG] fetch response: status=${res.status} ok=${res.ok}`);
                if (!res.ok) throw new Error(`Fetch failed with status ${res.status} ${res.statusText}`);

                const data = await res.json();
                const albums = Array.isArray(data) ? data : (data.albums || []);
                if (!albums.length) {
                    console.warn('[DEBUG] No albums in JSON, using fallback');
                    renderAlbums(FALLBACK_LIBRARY, row, true);
                    return;
                }

                renderAlbums(albums, row, false);
            } catch (err) {
                console.error('[ERROR] Could not load library.json:', err);
                renderAlbums(FALLBACK_LIBRARY, row, true);
            }
        }

        function renderAlbums(list, row, fromFallback = false) {
            row.innerHTML = '';
            list.forEach(album => {
                const col = el('div', { class: 'col-xl-2 col-md-3 col-sm-6 col-12 mb-4' });
                const card = el('div', { class: 'card h-100 shadow-sm' });

                const img = el('img', { class: 'album-img card-img-top', attrs: { src: `assets/img/${album.thumbnail}`, alt: `${album.artist} - ${album.title}` } });
                const cardBody = el('div', { class: 'card-body d-flex flex-column' });
                const title = el('h5', { class: 'card-title mb-1', text: album.artist });
                const subtitle = el('p', { class: 'card-text text-muted mb-3', text: album.title });
                const btn = el('button', {
                    class: 'btn btn-primary mt-auto', text: 'View Tracklist', attrs: {
                        type: 'button',
                        'data-bs-toggle': 'modal',
                        'data-bs-target': '#exampleModal',
                        'data-album-id': album.id ?? album.title
                    }
                });

                cardBody.appendChild(title);
                cardBody.appendChild(subtitle);
                cardBody.appendChild(btn);
                card.appendChild(img);
                card.appendChild(cardBody);

                const footer = el('div', { class: 'card-footer text-muted small', html: `Tracks: ${(album.tracks && album.tracks.length) || 0}` });
                card.appendChild(footer);

                col.appendChild(card);
                row.appendChild(col);
            });
        }

        document.addEventListener('DOMContentLoaded', loadAlbums);
    </script>
</body>

</html>